{% load static %}
{% if block %}
<section class="pt-12 bg-stone-50">
  {% if block.title %}
  <div class="text-center">
    <h2 class="text-4xl font-bold">{{ block.title }}</h2>
  </div>
  {% endif %}

  <div class="slider-wrap">
    <div id="card-cert-block" class="w-full gap-6 flex overflow-x-auto scroll-smooth snap-x snap-mandatory no-scrollbar
                                     p-[3rem] [scroll-padding-left:3rem] [scroll-padding-right:1.5rem]">
      {% for it in block.items.all %}
      <!-- Карточка с данными в data-атрибутах -->
      <article class="w-full max-w-[20rem] shadow-[0_18px_34px_0_rgba(99,99,99,0.04)] hover:shadow-[0_18px_24px_0_rgba(99,99,99,0.1)] hover:scale-105 transition-transform bg-white card-cert aspect-[16/14] rounded-[2rem] cursor-pointer flex-shrink-0 snap-start relative overflow-hidden transition-all duration-300"
               data-fleet-open="fleet-modal"
               data-item-id="{{ it.id }}"
               data-item-name="{{ it.name|escapejs }}"
               data-item-subtitle="{{ it.subtitle|escapejs }}"
               data-item-description="{{ it.description|escapejs }}"
               data-item-image="{{ it.image_src }}"
               data-item-specs='{% if it.specifications.all %}[{% for sp in it.specifications.all %}{"key":"{{ sp.key|escapejs }}","value":"{{ sp.value|escapejs }}"}{% if not forloop.last %},{% endif %}{% endfor %}]{% else %}[]{% endif %}'>
        <div class="flex flex-col h-full justify-between">
          <div class="flex justify-center relative pt-4">
            <div class="relative flex justify-center items-center overflow-hidden object-cover w-full aspect-[16/9] m-auto">
              <img src="{{ it.image_src }}" alt="{{ it.name }}"
                   class="absolute inset-0 w-full h-full object-cover object-center"
                   loading="lazy" decoding="async" draggable="false">
            </div>
          </div>
          <div class="pl-6 pr-4 pb-6">
            <h1 class="font-bold text-xl">{{ it.name }}</h1>
            <p class="mt-1 text-gray-600 text-sm font-bold leading-tight">{{ it.subtitle }}</p>
          </div>
          <div class="absolute right-4 bottom-4 pointer-events-none">
            <span class="size-12 bg-black/90 flex justify-center items-center rounded-full">
              <svg class="size-4" viewBox="0 0 14 13" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M0 1H13M13 1V12M13 1L2.05263 12" stroke="white" stroke-width="2"/>
              </svg>
            </span>
          </div>
        </div>
      </article>
      {% endfor %}
    </div>

    <!-- Одна универсальная модалка -->
    <div id="fleet-modal" class="fixed inset-0 z-[70] hidden" role="dialog" aria-modal="true" aria-labelledby="fleet-modal-title">
      <div class="absolute inset-0 bg-black/60" data-fleet-close></div>
      <div class="relative mx-auto my-10 w-full max-w-screen-sm max-h-[90vh] overflow-y-auto rounded-2xl bg-white shadow-xl">
        <div class="grid gap-0">
          <div class="bg-black/5">
            <img id="modal-image" src="" alt="" class="w-full h-full object-cover">
          </div>
          <div class="p-6">
            <div class="flex items-start justify-between gap-4">
              <div>
                <h3 id="modal-title" class="text-2xl font-bold"></h3>
                <p id="modal-subtitle" class="text-gray-600 mt-1"></p>
              </div>
              <button type="button" class="absolute top-4 right-4 z-50 rounded-full p-2 hover:bg-gray-100 bg-white/80 backdrop-blur" aria-label="Закрыть" data-fleet-close>
                <svg class="w-5 h-5" viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
              </button>
            </div>

            <div id="modal-description" class="mt-4 text-gray-800"></div>

            <div id="modal-specs-container" class="mt-6 hidden">
              <h4 class="font-semibold mb-2">{{ block.character_label|default:"Характеристики" }}</h4>
              <dl id="modal-specs" class="grid grid-cols-[auto,1fr] gap-x-4 gap-y-2"></dl>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="pointer-events-none fixed z-50 hidden drag-cursor"></div>
  </div>
</section>

<script>
(() => {
  function showModal(modal, card) {
    if (!modal) return;

    // Если передана карточка, заполняем модалку данными
    if (card) {
      const modalImage = modal.querySelector('#modal-image');
      const modalTitle = modal.querySelector('#modal-title');
      const modalSubtitle = modal.querySelector('#modal-subtitle');
      const modalDescription = modal.querySelector('#modal-description');
      const modalSpecsContainer = modal.querySelector('#modal-specs-container');
      const modalSpecs = modal.querySelector('#modal-specs');

      // Получаем данные из атрибутов карточки
      const itemData = {
        name: card.dataset.itemName || '',
        subtitle: card.dataset.itemSubtitle || '',
        description: card.dataset.itemDescription || '',
        image: card.dataset.itemImage || '',
        specs: []
      };

      // Парсим спецификации
      if (card.dataset.itemSpecs) {
        try {
          itemData.specs = JSON.parse(card.dataset.itemSpecs);
        } catch (e) {
          console.error('Error parsing specs:', e);
        }
      }

      // Заполняем модалку
      if (modalImage) {
        modalImage.src = itemData.image;
        modalImage.alt = itemData.name;
      }
      if (modalTitle) modalTitle.textContent = itemData.name;
      if (modalSubtitle) modalSubtitle.textContent = itemData.subtitle;

      // Описание
      if (modalDescription) {
        if (itemData.description && itemData.description.trim()) {
          modalDescription.innerHTML = itemData.description.split('\n').map(p => `<p>${p}</p>`).join('');
          modalDescription.style.display = 'block';
        } else {
          modalDescription.style.display = 'none';
        }
      }

      // Характеристики
      if (modalSpecsContainer && modalSpecs) {
        if (itemData.specs && itemData.specs.length > 0) {
          modalSpecs.innerHTML = '';
          itemData.specs.forEach(spec => {
            modalSpecs.innerHTML += `
              <dt class="text-gray-500">${spec.key}</dt>
              <dd class="text-gray-900 font-medium">${spec.value}</dd>
            `;
          });
          modalSpecsContainer.classList.remove('hidden');
        } else {
          modalSpecsContainer.classList.add('hidden');
        }
      }
    }

    modal.classList.remove('hidden');
    document.documentElement.classList.add('overflow-hidden');
  }

  function hideModal(modal) {
    modal.classList.add('hidden');
    document.documentElement.classList.remove('overflow-hidden');
  }

  // Используем pointerup вместо click, так как click блокируется drag скриптом
  document.addEventListener('pointerup', (e) => {
    // Проверяем, что контейнер не в режиме перетаскивания
    const slider = document.getElementById('card-cert-block');
    if (slider && slider.dataset.dragging === '1') return;

    const openBtn = e.target.closest('[data-fleet-open]');
    if (openBtn) {
      const id = openBtn.getAttribute('data-fleet-open');
      const modal = document.getElementById(id);
      if (modal) {
        e.preventDefault();
        e.stopPropagation();
        showModal(modal, openBtn);
      }
    }
  });

  // Закрытие модалки - используем обычный click, так как модалка вне слайдера
  document.addEventListener('click', (e) => {
    if (e.target.closest('[data-fleet-close]')) {
      const modal = e.target.closest('[id^="fleet-modal"]');
      if (modal) {
        e.preventDefault();
        hideModal(modal);
      }
    }
  });

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      document.querySelectorAll('[id^="fleet-modal"]:not(.hidden)').forEach(hideModal);
    }
  });

  // Альтернативный метод: модифицируем navigateIfTap в drag скрипте
  // Ждем загрузки DOM и патчим функционал
  document.addEventListener('DOMContentLoaded', () => {
    setTimeout(() => {
      const slider = document.getElementById('card-cert-block');
      if (!slider) return;

      // Перехватываем pointerdown для сохранения начального элемента
      let startElement = null;

      slider.addEventListener('pointerdown', (e) => {
        startElement = e.target.closest('[data-fleet-open]');
      }, true);

      // Обрабатываем pointerup
      slider.addEventListener('pointerup', (e) => {
        if (slider.dataset.dragging === '1') return;

        const endElement = e.target.closest('[data-fleet-open]');
        // Проверяем, что кликнули на том же элементе, где начали
        if (startElement && endElement && startElement === endElement) {
          const id = endElement.getAttribute('data-fleet-open');
          const modal = document.getElementById(id);
          if (modal) {
            e.preventDefault();
            e.stopPropagation();
            showModal(modal, endElement);
          }
        }
      }, true);
    }, 100);
  });
})();
</script>
{% endif %}